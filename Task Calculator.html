<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager (Editable)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Stats */
        .stats-header { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .stat-label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 8px; }
        .stat-value { font-size: 36px; font-weight: bold; font-variant-numeric: tabular-nums; }
        .actual-color { color: #1e293b; }
        .billable-color { color: #2563eb; }

        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }

        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #f1f5f9; padding: 6px; border-radius: 10px; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 14px; color: #64748b; transition: 0.2s; }
        .tab.active { background: white; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Drag & Drop */
        .upload-section { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer; border-radius: 12px; background: #f8fafc; transition: 0.2s; }
        .upload-section.drag-active { background: #eff6ff; border-color: #3b82f6; }

        /* Inputs */
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        
        /* List */
        .task-list { border: 1px solid #f1f5f9; border-radius: 8px; max-height: 400px; overflow-y: auto; }
        .group-header { background: #f8fafc; padding: 12px 15px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; font-size: 13px; color:#475569; }
        .group-content { display: none; background: #fff; }
        .group-content.open { display: block; }
        .task-item { display: grid; grid-template-columns: 40px 1fr 80px; padding: 12px 15px; border-bottom: 1px solid #f8fafc; align-items: center; font-size: 14px; }
        .task-item.selected { background: #eff6ff; border-left: 4px solid #3b82f6; }
        .task-meta { font-size: 11px; color: #94a3b8; display: block; margin-top: 2px; }

        /* Call Tool */
        .call-tool { background: #f8fafc; padding: 30px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .call-input-group { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0; }
        .big-input { width: 120px; padding: 15px; font-size: 28px; text-align: center; border: 2px solid #e2e8f0; border-radius: 10px; }
        .btn-add { background: #2563eb; color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; margin-top:15px; }

        /* Summary Area */
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .action-btns button { background: none; border: none; cursor: pointer; font-size: 12px; font-weight: 600; padding: 5px 10px; border-radius: 4px; }
        .btn-copy { color: #2563eb; background: #eff6ff !important; }
        .btn-revert { color: #e53e3e; background: #fff5f5 !important; margin-right: 5px; display: none; } /* Hidden by default */
        
        textarea.summary-box { 
            background: #1e293b; color: #cbd5e1; padding: 15px; border-radius: 8px; 
            font-family: monospace; font-size: 13px; border: 1px solid #334155; border-left: 4px solid #3b82f6;
            width: 100%; min-height: 80px; resize: vertical; line-height: 1.4; outline: none;
        }
        textarea.summary-box:focus { border-color: #3b82f6; background: #0f172a; }
        .manual-mode-indicator { font-size: 10px; color: #f6ad55; font-weight: bold; display: none; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="stats-header">
        <div class="stat-card">
            <div class="stat-label">Actual Total</div>
            <div id="actualTotal" class="stat-value actual-color">0,00</div>
        </div>
        <div class="stat-card" style="border: 2px solid #3b82f6;">
            <div class="stat-label">Billable (Rounded)</div>
            <div id="roundedTotal" class="stat-value billable-color">0,00</div>
        </div>
    </div>

    <div class="card">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('tasks')">Task List</div>
            <div class="tab" onclick="switchTab('call')">Call Converter</div>
        </div>

        <div id="tasksContent" class="tab-content active">
            <div class="upload-section" id="dropZone">
                <input type="file" id="fileInput" accept=".xlsx,.xls" hidden />
                <div id="dropLabel"><strong>Drop Excel Here</strong><br><small>Headers: TaskName, TaskValue, TaskGroup, OutputString</small></div>
            </div>
            
            <div class="input-row">
                <div><div class="stat-label">Ticket #</div><input type="text" id="ticketNumber" placeholder="Ref #" oninput="render()"></div>
                <div><div class="stat-label">Search Tasks</div><input type="text" id="searchBar" placeholder="Search..." oninput="render()"></div>
            </div>
            <div class="task-list" id="taskList"></div>
        </div>

        <div id="callContent" class="tab-content">
            <div class="call-tool">
                <div class="stat-label">Minutes to Base 100</div>
                <div class="call-input-group">
                    <div>
                        <input type="number" id="callMinutes" class="big-input" placeholder="0" oninput="convertCall()">
                        <div class="stat-label" style="margin-top:8px;">MINUTES</div>
                    </div>
                    <div style="font-size:30px; color:#cbd5e1">â†’</div>
                    <div>
                        <div id="callDecimal" style="font-size:36px; font-weight:bold; color:#2563eb; width:120px">0,00</div>
                        <div class="stat-label" style="margin-top:8px;">DECIMAL</div>
                    </div>
                </div>
                <input type="text" id="callName" placeholder="Who did you call?" style="width:100%; padding:12px; margin-top:10px; border:1px solid #e2e8f0; border-radius:8px;">
                <button class="btn-add" onclick="addCallToTally()">Add Call to Ticket</button>
            </div>
        </div>

        <div style="margin-top:25px; padding-top:20px; border-top: 1px solid #f1f5f9;">
            <div class="summary-header">
                <div style="display:flex; align-items:center;">
                    <label class="stat-label" style="margin:0">Output Summary</label>
                    <span id="manualIndicator" class="manual-mode-indicator">âš  MANUAL EDIT MODE</span>
                </div>
                <div class="action-btns">
                    <button id="revertBtn" class="btn-revert" onclick="revertText()">â†º REVERT TO AUTO</button>
                    <button class="btn-copy" onclick="copyText()">COPY STRING</button>
                </div>
            </div>
            <textarea id="summaryText" class="summary-box" spellcheck="false" placeholder="No items selected."></textarea>
            
            <button onclick="resetTicket()" style="background:none; border:none; color:#94a3b8; font-size:11px; cursor:pointer; margin-top:15px; text-decoration:underline;">Wipe Ticket</button>
        </div>
    </div>
</div>

<script>
    let state = { tasks: [], selectedIds: [], adHoc: [], openGroups: [] };
    let isManualMode = false; // Flag to track manual edits

    const toComma = (num) => num.toFixed(2).replace('.', ',');

    // --- TEXT AREA LOGIC ---
    const textBox = document.getElementById('summaryText');
    const revertBtn = document.getElementById('revertBtn');
    const manualInd = document.getElementById('manualIndicator');

    // Listen for manual typing
    textBox.addEventListener('input', () => {
        isManualMode = true;
        revertBtn.style.display = 'inline-block';
        manualInd.style.display = 'block';
        textBox.style.borderColor = '#f6ad55'; // Orange border to indicate manual mode
    });

    function revertText() {
        if(confirm("Discard manual edits and revert to auto-generated list?")) {
            isManualMode = false;
            revertBtn.style.display = 'none';
            manualInd.style.display = 'none';
            textBox.style.borderColor = '#334155'; // Reset border
            calculate(); // Re-run calculation to fill box
        }
    }

    // --- DRAG & DROP ---
    const dropZone = document.getElementById('dropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        window.addEventListener(e, ev => ev.preventDefault(), false);
        dropZone.addEventListener(e, ev => ev.preventDefault(), false);
    });
    dropZone.addEventListener('dragover', () => dropZone.classList.add('drag-active'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-active'));
    dropZone.addEventListener('click', () => document.getElementById('fileInput').click());
    dropZone.addEventListener('drop', (e) => {
        dropZone.classList.remove('drag-active');
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
    });

    document.getElementById('fileInput').onchange = (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    };

    function handleFile(file) {
        document.getElementById('dropLabel').innerHTML = `<strong>Loaded:</strong> ${file.name}`;
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            state.tasks = data.map((r, i) => ({
                id: i, 
                name: r.TaskName || r.taskname || "Unknown", 
                out: r.OutputString || r.outputstring || null,
                val: parseFloat(String(r.TaskValue || r.taskvalue || 0).replace(',', '.')),
                group: r.TaskGroup || r.taskgroup || null
            }));
            render();
        };
        reader.readAsArrayBuffer(file);
    }

    // --- CORE UI ---
    function toggleGroup(groupName) {
        const idx = state.openGroups.indexOf(groupName);
        if (idx > -1) state.openGroups.splice(idx, 1);
        else state.openGroups.push(groupName);
        render();
    }

    function renderItem(t) {
        const isSelected = state.selectedIds.includes(t.id);
        return `
            <div class="task-item ${isSelected ? 'selected' : ''}">
                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleTask(${t.id})">
                <div>
                    <div style="font-weight:500">${t.name}</div>
                    ${t.out ? `<span class="task-meta">Output: ${t.out}</span>` : ''}
                </div>
                <div style="font-weight:bold; text-align:right">${toComma(t.val)}</div>
            </div>
        `;
    }

    function render() {
        const query = document.getElementById('searchBar').value.toLowerCase();
        const list = document.getElementById('taskList');
        const filtered = state.tasks.filter(t => t.name.toLowerCase().includes(query) || (t.group && t.group.toLowerCase().includes(query)));
        
        const groups = {}; 
        const ungrouped = [];

        filtered.forEach(t => {
            if (t.group) { 
                if (!groups[t.group]) groups[t.group] = []; 
                groups[t.group].push(t); 
            } else { 
                ungrouped.push(t); 
            }
        });

        let html = ungrouped.map(t => renderItem(t)).join('');

        for (const [groupName, tasks] of Object.entries(groups)) {
            const isOpen = state.openGroups.includes(groupName) || query.length > 0;
            html += `
                <div class="group-container">
                    <div class="group-header" onclick="toggleGroup('${groupName}')">
                        <span>ðŸ“‚ ${groupName} (${tasks.length})</span>
                        <span>${isOpen ? 'â–²' : 'â–¼'}</span>
                    </div>
                    <div class="group-content ${isOpen ? 'open' : ''}">
                        ${tasks.map(t => renderItem(t)).join('')}
                    </div>
                </div>
            `;
        }
        list.innerHTML = html || '<div style="padding:20px; color:#94a3b8; text-align:center;">No tasks found</div>';
        calculate();
    }

    function toggleTask(id) {
        const i = state.selectedIds.indexOf(id);
        if (i > -1) state.selectedIds.splice(i, 1);
        else state.selectedIds.push(id);
        calculate(); 
        render(); 
    }

    function convertCall() {
        const mins = parseFloat(document.getElementById('callMinutes').value) || 0;
        document.getElementById('callDecimal').textContent = toComma(mins / 60);
    }

    function addCallToTally() {
        const mins = parseFloat(document.getElementById('callMinutes').value) || 0;
        const name = document.getElementById('callName').value || "Customer";
        if(mins <= 0) return;

        state.adHoc.push({ name: `Phone call with ${name} for ${mins} minutes`, val: mins / 60 });
        
        document.getElementById('callMinutes').value = '';
        document.getElementById('callName').value = '';
        document.getElementById('callDecimal').textContent = '0,00';
        switchTab('tasks'); 
        render();
    }

    function calculate() {
        // 1. Calculate Math (Always happens)
        const selected = state.tasks.filter(t => state.selectedIds.includes(t.id));
        const actual = selected.reduce((s, t) => s + t.val, 0) + state.adHoc.reduce((s, t) => s + t.val, 0);
        const rounded = Math.ceil(actual * 4) / 4;

        document.getElementById('actualTotal').textContent = toComma(actual);
        document.getElementById('roundedTotal').textContent = toComma(rounded);
        
        // 2. Update Text (Only if NOT in manual mode)
        if (!isManualMode) {
            const tNum = document.getElementById('ticketNumber').value || "REF";
            // Use OutputString if available, otherwise name
            const taskLabels = selected.map(t => t.out || t.name);
            const allLabels = [...taskLabels, ...state.adHoc.map(t => t.name)];
            
            document.getElementById('summaryText').value = `#${tNum}: ${allLabels.join(', ') || '(no items)'}`;
        }
    }

    function switchTab(t) {
        document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
        if(t === 'tasks') { 
            document.querySelectorAll('.tab')[0].classList.add('active'); 
            document.getElementById('tasksContent').classList.add('active'); 
        } else { 
            document.querySelectorAll('.tab')[1].classList.add('active'); 
            document.getElementById('callContent').classList.add('active'); 
        }
    }

    function resetTicket() { 
        if(confirm("Clear this ticket?")) {
            state.selectedIds = []; 
            state.adHoc = []; 
            // Reset manual mode on wipe
            isManualMode = false;
            revertBtn.style.display = 'none';
            manualInd.style.display = 'none';
            textBox.style.borderColor = '#334155';
            render(); 
        }
    }

    function copyText() { 
        document.getElementById('summaryText').select();
        document.execCommand('copy');
        alert("Copied!"); 
    }
</script>
</body>
</html>