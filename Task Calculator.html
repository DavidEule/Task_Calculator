<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Material Billing - v12</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-sys-color-primary: #a8c7fa;
            --md-sys-color-on-primary: #062e6f;
            --md-sys-color-surface: #121314;
            --md-sys-color-surface-container: #1e1f20;
            --md-sys-color-outline: #444746;
            --md-sys-color-secondary-container: #333537;
            --md-sys-color-on-secondary-container: #e3e3e3;
            --md-sys-color-error: #f2b8b5;
            --md-sys-color-on-error: #601410;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Google Sans', sans-serif; }
        body { background: var(--md-sys-color-surface); color: var(--md-sys-color-on-secondary-container); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 300px; background: var(--md-sys-color-surface-container); padding: 40px 20px; border-right: 1px solid var(--md-sys-color-outline); display: flex; flex-direction: column; align-items: center; gap: 48px; }
        .clock-section { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .gauge-container { position: relative; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center; }
        .svg-gauge { transform: rotate(-90deg); width: 100%; height: 100%; position: absolute; }
        .svg-gauge circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .bg-ring { stroke: var(--md-sys-color-outline); opacity: 0.2; }
        .prog-ring { transition: stroke-dashoffset 0.5s linear; }
        .digital-val { font-family: 'Roboto Mono', monospace; font-size: 28px; font-weight: 700; z-index: 1; }

        /* MAIN */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; max-width: 1100px; margin: 0 auto; width: 100%; }
        .m3-card { background: var(--md-sys-color-surface-container); border-radius: 28px; padding: 32px; border: 1px solid var(--md-sys-color-outline); margin-bottom: 24px; position: relative; }
        
        /* ACTION BAR GRID */
        .action-row { display: grid; grid-template-columns: 110px 160px 1fr 130px; gap: 12px; margin-bottom: 20px; }

        /* TREE & DRAG ZONE */
        .tree-root { border: 1px solid var(--md-sys-color-outline); border-radius: 16px; padding: 16px; background: var(--md-sys-color-surface); min-height: 200px; max-height: 400px; overflow-y: auto; position: relative; transition: 0.2s; }
        .tree-root.dragover { border: 2px dashed var(--md-sys-color-primary); background: rgba(168, 199, 250, 0.1); transform: scale(1.01); }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; text-align: center; color: var(--md-sys-color-outline); cursor: pointer; }

        /* TREE ITEMS */
        .folder-node { margin-left: 20px; border-left: 1px solid var(--md-sys-color-outline); padding-left: 8px; }
        .folder-label { display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .folder-label:hover { background: var(--md-sys-color-secondary-container); }
        .folder-label::before { content: 'folder'; font-family: 'Material Icons'; margin-right: 10px; color: var(--md-sys-color-primary); font-size: 20px; }
        .task-leaf { display: flex; justify-content: space-between; padding: 8px 16px 8px 36px; border-radius: 8px; cursor: pointer; font-size: 13px; margin: 2px 0; }
        .task-leaf:hover { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }

        /* INPUTS */
        .m3-input { background: var(--md-sys-color-surface); border: 1px solid var(--md-sys-color-outline); padding: 14px 20px; border-radius: 14px; color: inherit; width: 100%; outline: none; transition: border 0.2s; font-size: 14px; }
        select.m3-input { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e3e3e3%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 16px center; background-size: 10px; cursor: pointer; }
        .is-dirty { border: 2px solid var(--md-sys-color-error) !important; }
        .dirty-msg { color: var(--md-sys-color-error); font-size: 11px; font-weight: 700; margin-top: 6px; display: none; }

        /* MODAL */
        #histModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; }
        .modal-card { background: var(--md-sys-color-surface-container); border-radius: 28px; width: 90%; max-width: 600px; padding: 32px; border: 1px solid var(--md-sys-color-outline); }

        /* BTNS */
        .m3-btn { padding: 12px 24px; border-radius: 20px; border: none; cursor: pointer; font-weight: 500; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-filled { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn-tonal { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
        .btn-error { background: var(--md-sys-color-error); color: var(--md-sys-color-on-error); }
        
        .hidden { display: none !important; }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

    <aside class="sidebar">
        <div class="clock-section">
            <span style="font-size: 10px; font-weight: 700; color: var(--md-sys-color-error)">GLOBAL MASTER</span>
            <div class="gauge-container">
                <svg class="svg-gauge" viewBox="0 0 100 100">
                    <circle class="bg-ring" cx="50" cy="50" r="45"></circle>
                    <circle id="gRing" class="prog-ring" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="283" style="stroke: var(--md-sys-color-error)"></circle>
                </svg>
                <span id="gClock" class="digital-val">00:00:00</span>
            </div>
            <div style="display: flex; gap: 8px; width: 100%;">
                <button id="gBtn" class="m3-btn btn-error" style="flex: 1" onclick="toggleG()">Start All</button>
                <button class="m3-btn btn-tonal" onclick="masterReset()"><span class="material-icons">refresh</span></button>
            </div>
        </div>
        <div class="clock-section">
            <span style="font-size: 10px; font-weight: 700; color: var(--md-sys-color-primary)">BILLABLE SESSION</span>
            <div class="gauge-container">
                <svg class="svg-gauge" viewBox="0 0 100 100">
                    <circle class="bg-ring" cx="50" cy="50" r="45"></circle>
                    <circle id="bRing" class="prog-ring" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="283" style="stroke: var(--md-sys-color-primary)"></circle>
                </svg>
                <span id="bClock" class="digital-val" style="color: var(--md-sys-color-primary)">00:00:00</span>
            </div>
            <button id="bBtn" class="m3-btn btn-filled" style="width: 100%;" onclick="toggleB()">Pause</button>
            <button class="m3-btn btn-tonal" style="width: 100%;" onclick="tallyB()">Push Tally</button>
        </div>
    </aside>

    <main class="main-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
            <div class="m3-card" style="margin:0">
                <p style="font-size: 11px; font-weight: 700; opacity: 0.6">ACTUAL HOURS</p>
                <h1 id="actTotal" style="font-size: 42px;">0,00</h1>
            </div>
            <div class="m3-card" style="margin:0; background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary)">
                <p style="font-size: 11px; font-weight: 700; opacity: 0.8">ROUNDED BILLING</p>
                <h1 id="billTotal" style="font-size: 42px;">0,00</h1>
            </div>
        </div>

        <div class="m3-card">
            <div class="action-row">
                <input type="text" id="refNum" class="m3-input" placeholder="Ticket #" oninput="sync(true)">
                
                <select id="callType" class="m3-input" onchange="sync(true)">
                    <option value="">(No Type)</option>
                    <option value="Remote">Remote</option>
                    <option value="On-Site">On-Site</option>
                    <option value="Workshop">Workshop</option>
                    <option value="Travel">Travel</option>
                    <option value="Admin">Admin</option>
                </select>

                <input type="text" id="search" class="m3-input" placeholder="Search tasks..." oninput="handleSearch()">
                <button id="histBtn" class="m3-btn btn-filled" onclick="openAudit()">Audit (0)</button>
            </div>

            <div id="searchResults" class="hidden" style="margin-bottom:12px; border:1px solid var(--md-sys-color-primary); border-radius:16px; background:var(--md-sys-color-surface); overflow:hidden;"></div>

            <div id="treeUI" class="tree-root" onclick="if(!state.tasksFlat.length) document.getElementById('fileIn').click()">
                <div id="emptyMsg" class="empty-state">
                    <span class="material-icons" style="font-size: 48px; margin-bottom: 12px;">cloud_upload</span>
                    <p>uh oh... nothing to select,<br><b>press here to import</b> or just <b>drag and drop</b> an excel spreadsheet</p>
                </div>
            </div>
            <input type="file" id="fileIn" hidden onchange="handleExcel(this.files[0])">

            <div style="margin-top: 32px; border-top: 1px solid var(--md-sys-color-outline); padding-top: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <p style="font-size: 11px; font-weight: 700;">FINAL SUMMARY</p>
                    <button id="revertBtn" class="m3-btn btn-tonal hidden" style="padding: 4px 12px; font-size: 11px;" onclick="revertString()">
                        <span class="material-icons" style="font-size: 14px;">history</span> Revert String
                    </button>
                </div>
                <textarea id="output" class="m3-input" style="min-height: 100px; font-family: 'Roboto Mono'" oninput="markDirty()"></textarea>
                <div id="dirtyNote" class="dirty-msg">! WARNING: STRING MODIFIED MANUALLY - AUTO-SYNC DISABLED</div>
                <button class="m3-btn btn-filled" style="width:100%; margin-top:16px;" onclick="copyOutput()">Copy String</button>
            </div>
        </div>
    </main>

    <div id="histModal">
        <div class="modal-card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 24px; align-items: center;">
                <h2 style="font-weight: 400;">Audit History</h2>
                <button class="m3-btn btn-tonal" onclick="closeAudit()"><span class="material-icons">close</span></button>
            </div>
            <div id="histTable" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

<script>
    let state = {
        hist: JSON.parse(localStorage.getItem('billing_v12')) || [],
        tasksFlat: [], tree: {}, expanded: new Set(),
        g: { running: false, start: null, elapsed: 0 },
        b: { running: false, start: null, elapsed: 0 },
        isDirty: false
    };

    window.onload = () => { 
        // Restore Call Type if saved
        const savedType = localStorage.getItem('billing_calltype');
        if(savedType) document.getElementById('callType').value = savedType;
        sync(true); 
    };

    function masterReset() {
        if (!confirm("PERMANENTLY delete history and reset clocks?")) return;
        state = { hist: [], tasksFlat: state.tasksFlat, tree: state.tree, expanded: new Set(), g: { running: false, start: null, elapsed: 0 }, b: { running: false, start: null, elapsed: 0 }, isDirty: false };
        localStorage.removeItem('billing_v12');
        localStorage.removeItem('billing_calltype');
        
        document.getElementById('gClock').innerText = "00:00:00";
        document.getElementById('bClock').innerText = "00:00:00";
        document.getElementById('gRing').style.strokeDashoffset = 283;
        document.getElementById('bRing').style.strokeDashoffset = 283;
        document.getElementById('gBtn').innerText = "Start All";
        document.getElementById('output').classList.remove('is-dirty');
        document.getElementById('dirtyNote').style.display = 'none';
        document.getElementById('revertBtn').classList.add('hidden');
        document.getElementById('callType').value = "";
        sync(true);
    }

    // --- AUDIT ---
    function openAudit() { renderAuditTable(); document.getElementById('histModal').style.display = 'flex'; }
    function closeAudit() { document.getElementById('histModal').style.display = 'none'; }
    function renderAuditTable() {
        const c = document.getElementById('histTable');
        if (!state.hist.length) { c.innerHTML = `<div style="padding:40px; text-align:center; opacity:0.5;">No history recorded yet.</div>`; return; }
        c.innerHTML = state.hist.map(h => `<div style="display:flex; justify-content:space-between; padding:16px; border-bottom:1px solid var(--md-sys-color-outline); align-items:center;"><div><div style="font-weight:500;">${h.label}</div><small style="opacity:0.6">${h.path}</small></div><div style="display:flex; align-items:center; gap:16px;"><b style="font-family:'Roboto Mono'">${h.val.toFixed(2)}</b><button class="m3-btn btn-tonal" style="padding:8px; border-radius:12px;" onclick="deleteEntry(${h.id})"><span class="material-icons" style="font-size:18px; color:var(--md-sys-color-error)">delete</span></button></div></div>`).reverse().join('');
    }
    function deleteEntry(id) { state.hist = state.hist.filter(h => h.id !== id); saveAndSync(); renderAuditTable(); }

    // --- DATA ---
    function addH(l, v, p) { state.hist.push({ id: Date.now() + Math.random(), label: l, val: v, path: p }); document.getElementById('search').value = ""; handleSearch(); saveAndSync(); }
    function saveAndSync() { localStorage.setItem('billing_v12', JSON.stringify(state.hist)); sync(false); }

    function sync(force) {
        // Save Call Type preference
        const cType = document.getElementById('callType').value;
        localStorage.setItem('billing_calltype', cType);

        const act = state.hist.reduce((a, b) => a + b.val, 0);
        document.getElementById('actTotal').innerText = act.toFixed(2).replace('.', ',');
        document.getElementById('billTotal').innerText = (Math.ceil(act * 4) / 4).toFixed(2).replace('.', ',');
        document.getElementById('histBtn').innerText = `Audit (${state.hist.length})`;

        if (!state.isDirty || force) {
            const ref = document.getElementById('refNum').value;
            // PREFIX LOGIC: "CallType - #Ticket: Task1, Task2"
            let prefix = "";
            if (cType) prefix += `${cType}`;
            if (ref) prefix += (prefix ? ` - #${ref}` : `#${ref}`);
            if (prefix) prefix += ": ";
            
            document.getElementById('output').value = prefix + state.hist.map(h => h.label).join(', ');
        }
    }

    // --- CLOCKS ---
    function toggleG() {
        if (!state.g.running) { state.g.start = Date.now() - state.g.elapsed; state.g.running = true; if (!state.b.running) { state.b.start = Date.now() - state.b.elapsed; state.b.running = true; } document.getElementById('gBtn').innerText = "Stop Master"; } 
        else { state.g.elapsed = Date.now() - state.g.start; state.g.running = false; document.getElementById('gBtn').innerText = "Start All"; }
    }
    function toggleB() {
        if (!state.b.running) { state.b.start = Date.now() - state.b.elapsed; state.b.running = true; } 
        else { state.b.elapsed = Date.now() - state.b.start; state.b.running = false; }
    }
    setInterval(() => {
        if (state.g.running) { const ms = Date.now() - state.g.start; document.getElementById('gClock').innerText = new Date(ms).toISOString().substr(11, 8); document.getElementById('gRing').style.strokeDashoffset = 283 - (283 * ((ms % 60000) / 60000)); }
        if (state.b.running) { const ms = Date.now() - state.b.start; document.getElementById('bClock').innerText = new Date(ms).toISOString().substr(11, 8); document.getElementById('bRing').style.strokeDashoffset = 283 - (283 * ((ms % 60000) / 60000)); document.getElementById('bBtn').innerText = "Pause"; } else { document.getElementById('bBtn').innerText = "Resume"; }
    }, 1000);
    function tallyB() { const ms = state.b.running ? (Date.now() - state.b.start) : state.b.elapsed; if (ms < 1000) return; addH("Timer Session", ms/3600000, "Tracker"); state.b = { running: false, start: null, elapsed: 0 }; document.getElementById('bClock').innerText = "00:00:00"; }

    // --- EXCEL ---
    function handleExcel(f) {
        const r = new FileReader();
        r.onload = (e) => {
            const data = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).SheetNames[0]]);
            state.tasksFlat = data.map(x => ({ name: String(x.TaskName || "Task"), val: parseFloat(String(x.TaskValue || 0).replace(',','.')), path: String(x.TaskGroup || "General") }));
            document.getElementById('emptyMsg').classList.add('hidden');
            buildTree(); renderTree();
        };
        r.readAsArrayBuffer(f);
    }
    function buildTree() { state.tree = {}; state.tasksFlat.forEach(t => { const parts = t.path.split('|').map(p => p.trim()); let curr = state.tree; parts.forEach(p => { if(!curr[p]) curr[p] = { _t: [], _s: {} }; curr = curr[p]._s; }); let leaf = state.tree; parts.forEach((p, i) => { if(i === parts.length-1) leaf[p]._t.push(t); leaf = leaf[p]._s; }); }); }
    function renderTree(obj = state.tree, fullPath = "") { let html = ""; for (const k in obj) { const path = fullPath ? `${fullPath}|${k}` : k; const isOpen = state.expanded.has(path); html += `<div class="folder-node"><div class="folder-label" onclick="toggleF('${path}')">${k}</div><div class="folder-content" style="display:${isOpen?'block':'none'}">${renderTree(obj[k]._s, path)}${obj[k]._t.map(t => `<div class="task-leaf" onclick="addH('${t.name}', ${t.val}, '${path}')"><span>${t.name}</span><b>${t.val.toFixed(2)}</b></div>`).join('')}</div></div>`; } if (!fullPath) document.getElementById('treeUI').innerHTML = html; return html; }
    function toggleF(p) { if(state.expanded.has(p)) state.expanded.delete(p); else state.expanded.add(p); renderTree(); }

    // --- UI HELPERS ---
    function handleSearch() {
        const q = document.getElementById('search').value.toLowerCase();
        if (!q) { document.getElementById('searchResults').classList.add('hidden'); document.getElementById('treeUI').classList.remove('hidden'); return; }
        const matches = state.tasksFlat.filter(t => t.name.toLowerCase().includes(q));
        document.getElementById('treeUI').classList.add('hidden'); document.getElementById('searchResults').classList.remove('hidden');
        document.getElementById('searchResults').innerHTML = matches.map(t => `<div class="task-leaf" style="padding:12px 20px" onclick="addH('${t.name}', ${t.val}, '${t.path}')"><div><b>${t.name}</b><br><small style="opacity:0.5">${t.path}</small></div><b>${t.val.toFixed(2)}</b></div>`).join('');
    }
    function markDirty() { state.isDirty = true; document.getElementById('output').classList.add('is-dirty'); document.getElementById('dirtyNote').style.display = 'block'; document.getElementById('revertBtn').classList.remove('hidden'); }
    function revertString() { state.isDirty = false; document.getElementById('output').classList.remove('is-dirty'); document.getElementById('dirtyNote').style.display = 'none'; document.getElementById('revertBtn').classList.add('hidden'); sync(true); }
    function copyOutput() { document.getElementById('output').select(); document.execCommand('copy'); }
    
    // DRAG
    const d = document.getElementById('treeUI');
    ['dragenter','dragover','dragleave','drop'].forEach(e => d.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }));
    d.addEventListener('dragover', () => d.classList.add('dragover'));
    d.addEventListener('dragleave', () => d.classList.remove('dragover'));
    d.addEventListener('drop', e => { d.classList.remove('dragover'); if(e.dataTransfer.files[0]) handleExcel(e.dataTransfer.files[0]); });
</script>
</body>
</html>